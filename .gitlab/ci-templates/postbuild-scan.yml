# ~~ Generated by projen. To modify, edit .projenrc.js and run "pnpm dlx projen".

stages:
  - qa
postbuild-viperlight:
  stage: qa
  image:
    name: public.ecr.aws/docker/library/python:3.11
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  before_script:
    - curl -sL https://deb.nodesource.com/setup_16.x | bash -
    - curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | gpg --dearmor | tee /usr/share/keyrings/yarnkey.gpg >/dev/null
    - echo "deb [signed-by=/usr/share/keyrings/yarnkey.gpg] https://dl.yarnpkg.com/debian stable main" | tee /etc/apt/sources.list.d/yarn.list
    - apt-get update && apt-get install -y nodejs npm yarn
    - curl https://viperlight-scanner.s3.us-east-1.amazonaws.com/latest/.viperlightrc -o .viperlightrc
    - curl https://viperlight-scanner.s3.us-east-1.amazonaws.com/latest/codescan-funcs.sh -o codescan-funcs.sh
    - curl https://viperlight-scanner.s3.us-east-1.amazonaws.com/latest/viperlight.zip -o viperlight.zip
    - unzip -q viperlight.zip -d ../viperlight && rm viperlight.zip
  script:
    - mv build/deployment/global-s3-assets ./deployment/
    - ./codescan-prebuild-custom.sh
